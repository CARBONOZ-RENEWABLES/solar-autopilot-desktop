<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARBONOZ SolarAutopilot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="<%= ingress_path %>/css/main.css">
    <link rel="stylesheet" href="<%= ingress_path %>/css/settings.css">
</head>
<body>
    <!-- Mobile toggle button -->
    <button class="mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="container">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>

        <%- include('partials/sidebar') %>

        <div class="main-content">
            <div class="container">
                <!-- Header Section -->
                <div class="settings-header">
                    <div class="header-content">
                        <h1><i class="fas fa-cog"></i> System Settings</h1>
                        <p>Configure your SolarAutopilot system for optimal performance</p>
                    </div>
                    <div class="header-actions">
                        <button class="settings-btn primary" onclick="saveAllSettings()">
                            <i class="fas fa-save"></i> Save All
                        </button>
                        <button class="settings-btn secondary" onclick="resetAllSettings()">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="settings-btn secondary" onclick="exportSettings()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>

                <!-- Settings Categories -->
                <div class="settings-categories">
                    <div class="category-card active" data-category="general">
                        <div class="category-icon">
                            <i class="fas fa-sliders-h"></i>
                        </div>
                        <div class="category-content">
                            <div class="category-title">General Settings</div>
                            <div class="category-description">Basic system configuration</div>
                        </div>
                    </div>
                    <div class="category-card" data-category="tibber">
                        <div class="category-icon">
                            <i class="fas fa-bolt"></i>
                        </div>
                        <div class="category-content">
                            <div class="category-title">Tibber Settings</div>
                            <div class="category-description">Dynamic pricing configuration</div>
                        </div>
                    </div>
                    <div class="category-card" data-category="range">
                        <div class="category-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="category-content">
                            <div class="category-title">Range Settings</div>
                            <div class="category-description">Device range configuration</div>
                        </div>
                    </div>
                </div>

                <!-- Settings Content -->
                <div class="settings-content">
                    <!-- General Settings -->
                    <div id="general-settings" class="settings-section active">
                        <div class="section-header">
                            <h2><i class="fas fa-sliders-h"></i> General Settings</h2>
                            <p>Configure basic system parameters and API connections</p>
                        </div>

                        <div class="settings-grid">
                            <!-- Timezone Configuration -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-globe"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Timezone</h3>
                                        <p>Set your local timezone for accurate scheduling</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <select id="timezone" class="form-select">
                                        <option value="UTC">(GMT+00:00) UTC</option>
                                        <option value="Europe/London">(GMT+00:00) London</option>
                                        <option value="Europe/Berlin">(GMT+01:00) Berlin</option>
                                        <option value="Europe/Paris">(GMT+01:00) Paris</option>
                                        <option value="Europe/Rome">(GMT+01:00) Rome</option>
                                        <option value="Europe/Madrid">(GMT+01:00) Madrid</option>
                                        <option value="Europe/Amsterdam">(GMT+01:00) Amsterdam</option>
                                        <option value="Europe/Vienna">(GMT+01:00) Vienna</option>
                                        <option value="Europe/Stockholm">(GMT+01:00) Stockholm</option>
                                        <option value="Europe/Oslo">(GMT+01:00) Oslo</option>
                                        <option value="Europe/Copenhagen">(GMT+01:00) Copenhagen</option>
                                        <option value="Europe/Helsinki">(GMT+02:00) Helsinki</option>
                                        <option value="Europe/Athens">(GMT+02:00) Athens</option>
                                        <option value="America/New_York">(GMT-05:00) New York</option>
                                        <option value="America/Chicago">(GMT-06:00) Chicago</option>
                                        <option value="America/Denver">(GMT-07:00) Denver</option>
                                        <option value="America/Los_Angeles">(GMT-08:00) Los Angeles</option>
                                        <option value="Asia/Tokyo">(GMT+09:00) Tokyo</option>
                                        <option value="Asia/Shanghai">(GMT+08:00) Shanghai</option>
                                        <option value="Australia/Sydney">(GMT+10:00) Sydney</option>
                                    </select>
                                </div>
                            </div>

                            <!-- API Key Configuration -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Electricity Map API Key</h3>
                                        <p>Required for carbon intensity data</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <div class="input-group">
                                        <input type="password" id="apiKey" class="form-input" placeholder="Enter API key">
                                        <button type="button" class="input-btn" onclick="toggleApiKeyVisibility()">
                                            <i class="fas fa-eye" id="apiKeyIcon"></i>
                                        </button>
                                    </div>
                                    <div class="setting-help">
                                        <a href="https://www.electricitymaps.com/" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> Get your API key
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Zone Selection -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-map-marker-alt"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Carbon Intensity Zone</h3>
                                        <p>Select your electricity grid zone</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <select id="zone" class="form-select">
                                        <option value="">-- Select a zone --</option>
                                        <% zones.forEach(function(zone) { %>
                                            <option value="<%= zone.code %>" <%= settings.selectedZone === zone.code ? 'selected' : '' %>>
                                                <%= zone.zoneName %> (<%= zone.code %>)
                                            </option>
                                        <% }); %>
                                    </select>
                                </div>
                            </div>

                            <!-- System Status -->
                            <div class="setting-card status-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>System Status</h3>
                                        <p>Current system health and connectivity</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <div class="status-indicators">
                                        <div class="status-item">
                                            <span class="status-label">API Connection</span>
                                            <span class="status-badge" id="apiStatus">
                                                <i class="fas fa-circle"></i> Checking...
                                            </span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">Zone Configuration</span>
                                            <span class="status-badge" id="zoneStatus">
                                                <i class="fas fa-circle"></i> Not Set
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tibber Settings -->
                    <div id="tibber-settings" class="settings-section">
                        <div class="section-header">
                            <h2><i class="fas fa-bolt"></i> Tibber Settings</h2>
                            <p>Configure dynamic electricity pricing for smart charging optimization</p>
                        </div>

                        <div class="settings-grid">
                            <!-- Tibber Enable/Disable -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-power-off"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Enable Tibber Integration</h3>
                                        <p>Activate dynamic pricing for optimal charging</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="tibberEnabled">
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>

                            <!-- Tibber API Key -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-key"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Tibber API Key</h3>
                                        <p>Your personal Tibber API access token</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <div class="input-group">
                                        <input type="password" id="tibberApiKey" class="form-input" placeholder="Enter Tibber API key">
                                        <button type="button" class="input-btn" onclick="toggleTibberApiKeyVisibility()">
                                            <i class="fas fa-eye" id="tibberApiKeyIcon"></i>
                                        </button>
                                    </div>
                                    <div class="setting-help">
                                        <a href="https://developer.tibber.com" target="_blank">
                                            <i class="fas fa-external-link-alt"></i> Get your Tibber API key
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Country Selection -->
                            <div class="setting-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-flag"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Country</h3>
                                        <p>Select your country for proper pricing</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <select id="tibberCountry" class="form-select">
                                        <option value="DE">ðŸ‡©ðŸ‡ª Germany</option>
                                        <option value="NO">ðŸ‡³ðŸ‡´ Norway</option>
                                        <option value="SE">ðŸ‡¸ðŸ‡ª Sweden</option>
                                        <option value="DK">ðŸ‡©ðŸ‡° Denmark</option>
                                        <option value="FI">ðŸ‡«ðŸ‡® Finland</option>
                                        <option value="AT">ðŸ‡¦ðŸ‡¹ Austria</option>
                                        <option value="NL">ðŸ‡³ðŸ‡± Netherlands</option>
                                        <option value="GB">ðŸ‡¬ðŸ‡§ United Kingdom</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Tibber Status -->
                            <div class="setting-card status-card">
                                <div class="setting-header">
                                    <div class="setting-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="setting-info">
                                        <h3>Tibber Status</h3>
                                        <p>Current pricing and connection status</p>
                                    </div>
                                </div>
                                <div class="setting-control">
                                    <div class="status-indicators">
                                        <div class="status-item">
                                            <span class="status-label">Connection</span>
                                            <span class="status-badge" id="tibberConnectionStatus">
                                                <i class="fas fa-circle"></i> Disconnected
                                            </span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">Current Price</span>
                                            <span class="status-value" id="currentPrice">-- cent/kWh</span>
                                        </div>
                                        <div class="status-item">
                                            <span class="status-label">Price Level</span>
                                            <span class="status-badge" id="priceLevel">
                                                <i class="fas fa-circle"></i> Unknown
                                            </span>
                                        </div>
                                    </div>
                                    <div class="setting-actions">
                                        <button class="settings-btn secondary" onclick="testTibberConnection()">
                                            <i class="fas fa-plug"></i> Test Connection
                                        </button>
                                        <button class="settings-btn secondary" onclick="refreshTibberData()">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                        <button class="settings-btn primary" onclick="saveTibberSettings()">
                                            <i class="fas fa-save"></i> Save
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Range Settings -->
                    <div id="range-settings" class="settings-section">
                        <div class="section-header">
                            <h2><i class="fas fa-chart-line"></i> Range Settings</h2>
                            <p>Configure min/max values and thresholds for your devices</p>
                        </div>

                        <div class="range-grid" id="rangeGrid">
                            <!-- Range cards will be dynamically loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="settings-modal">
        <div class="modal-overlay" onclick="closeConfirmationModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle"></i> Confirm Action</h3>
                <button class="modal-close" onclick="closeConfirmationModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage">Are you sure you want to proceed?</p>
            </div>
            <div class="modal-footer">
                <button class="settings-btn secondary" onclick="closeConfirmationModal()">Cancel</button>
                <button class="settings-btn primary" id="confirmButton" onclick="confirmAction()">Confirm</button>
            </div>
        </div>
    </div>

    <script src="<%= ingress_path %>/js/dark-mode.js"></script>
    <script src="<%= ingress_path %>/js/mobile.js"></script>
    <script src="<%= ingress_path %>/js/loading.js"></script>

    <script>
        const ingressPath = '<%= ingress_path %>';
        let currentSettings = {};
        let pendingAction = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            initializeSettings();
            loadCurrentSettings();
            loadRangeSettings();
            setupEventListeners();
        });

        function initializeSettings() {
            // Set initial values from server
            document.getElementById('apiKey').value = '<%= settings.apiKey || "" %>';
            document.getElementById('zone').value = '<%= settings.selectedZone || "" %>';
            
            // Update status indicators
            updateStatusIndicators();
        }

        function setupEventListeners() {
            // Category switching
            document.querySelectorAll('.category-card').forEach(card => {
                card.addEventListener('click', function() {
                    const category = this.dataset.category;
                    switchCategory(category);
                });
            });

            // Auto-save on input changes
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', function() {
                    if (this.id !== 'confirmButton') {
                        autoSave();
                    }
                });
            });
        }

        function switchCategory(category) {
            // Update active category card
            document.querySelectorAll('.category-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('active');

            // Update active settings section
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${category}-settings`).classList.add('active');

            // Load specific data if needed
            if (category === 'tibber') {
                loadTibberStatus();
            } else if (category === 'range') {
                loadRangeSettings();
            }
        }

        async function loadCurrentSettings() {
            try {
                // Load timezone
                const timezoneResponse = await fetch(`${ingressPath}/api/timezone`);
                const timezoneData = await timezoneResponse.json();
                if (timezoneData.timezone) {
                    document.getElementById('timezone').value = timezoneData.timezone;
                }

                // Load Tibber config
                const tibberResponse = await fetch(`${ingressPath}/api/tibber/config`);
                const tibberData = await tibberResponse.json();
                if (tibberData.success) {
                    document.getElementById('tibberEnabled').checked = tibberData.config.enabled || false;
                    document.getElementById('tibberApiKey').value = tibberData.config.apiKey || '';
                    document.getElementById('tibberCountry').value = tibberData.config.country || 'DE';
                }

                updateStatusIndicators();
            } catch (error) {
                console.error('Error loading settings:', error);
                showToast('Error loading settings', 'error');
            }
        }

        async function loadTibberStatus() {
            try {
                const response = await fetch(`${ingressPath}/api/tibber/status`);
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    
                    // Update connection status
                    const connectionStatus = document.getElementById('tibberConnectionStatus');
                    if (status.configured && status.enabled) {
                        connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Connected';
                        connectionStatus.className = 'status-badge connected';
                    } else {
                        connectionStatus.innerHTML = '<i class="fas fa-circle"></i> Disconnected';
                        connectionStatus.className = 'status-badge disconnected';
                    }

                    // Update price info
                    if (status.currentPrice) {
                        document.getElementById('currentPrice').textContent = 
                            status.currentPrice.total.toFixed(2) + ' cent/kWh';
                        
                        const priceLevel = document.getElementById('priceLevel');
                        priceLevel.innerHTML = `<i class="fas fa-circle"></i> ${status.currentPrice.level}`;
                        priceLevel.className = `status-badge ${status.currentPrice.level.toLowerCase()}`;
                    }
                }
            } catch (error) {
                console.error('Error loading Tibber status:', error);
            }
        }

        async function loadRangeSettings() {
            try {
                const response = await fetch(`${ingressPath}/api/solar-data`);
                const data = await response.json();
                
                const rangeGrid = document.getElementById('rangeGrid');
                rangeGrid.innerHTML = '';

                for (const [key, value] of Object.entries(data)) {
                    if (value) {
                        const rangeCard = createRangeCard(key, value);
                        rangeGrid.appendChild(rangeCard);
                    }
                }
            } catch (error) {
                console.error('Error loading range settings:', error);
                showToast('Error loading range settings', 'error');
            }
        }

        function createRangeCard(id, config) {
            const card = document.createElement('div');
            card.className = 'range-card';
            
            // Enhanced icon mapping for specific Range Settings
            const iconMap = {
                'Load Power': 'fa-home',
                'Grid Voltage': 'fa-tachometer-alt', 
                'Battery Power': 'fa-battery-half',
                'Grid Power': 'fa-plug',
                'Solar PV Power': 'fa-sun',
                'Battery SOC': 'fa-battery-three-quarters',
                'Battery Voltage': 'fa-car-battery',
                // Fallback mappings
                'battery': 'fa-battery-half',
                'solar': 'fa-sun',
                'grid': 'fa-plug',
                'inverter': 'fa-microchip',
                'load': 'fa-home',
                'power': 'fa-bolt',
                'voltage': 'fa-tachometer-alt',
                'soc': 'fa-battery-three-quarters'
            };
            
            // Determine icon - exact match first, then fallback
            let icon = config.icon || iconMap[config.title] || iconMap[id] || 'fa-chart-line';
            
            // Fallback keyword matching if no exact match
            if (!config.icon && !iconMap[config.title] && !iconMap[id]) {
                const title = (config.title || id).toLowerCase();
                if (title.includes('load') && title.includes('power')) icon = 'fa-home';
                else if (title.includes('grid') && title.includes('voltage')) icon = 'fa-tachometer-alt';
                else if (title.includes('battery') && title.includes('power')) icon = 'fa-battery-half';
                else if (title.includes('grid') && title.includes('power')) icon = 'fa-plug';
                else if (title.includes('solar') || title.includes('pv')) icon = 'fa-sun';
                else if (title.includes('battery') && title.includes('soc')) icon = 'fa-battery-three-quarters';
                else if (title.includes('battery') && title.includes('voltage')) icon = 'fa-car-battery';
                else if (title.includes('battery')) icon = 'fa-battery-half';
                else if (title.includes('voltage')) icon = 'fa-tachometer-alt';
                else if (title.includes('power')) icon = 'fa-bolt';
            }
            
            // Determine card type for styling
            let cardType = 'default';
            if (id.toLowerCase().includes('battery')) cardType = 'battery';
            else if (id.toLowerCase().includes('solar') || id.toLowerCase().includes('pv')) cardType = 'solar';
            else if (id.toLowerCase().includes('grid') || id.toLowerCase().includes('mains')) cardType = 'grid';
            else if (id.toLowerCase().includes('inverter')) cardType = 'inverter';
            else if (id.toLowerCase().includes('load') || id.toLowerCase().includes('consumption')) cardType = 'load';
            
            card.setAttribute('data-type', cardType);
            
            card.innerHTML = `
                <div class="range-header">
                    <div class="range-icon">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div class="range-info">
                        <h3>${config.title || id.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase())}</h3>
                        <p>Configure min/max values and operational thresholds</p>
                    </div>
                </div>
                <div class="range-controls">
                    <div class="range-inputs">
                        <div class="input-group">
                            <label>Min Value</label>
                            <input type="number" id="min-${id}" value="${config.min || 0}" class="form-input" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Max Value</label>
                            <input type="number" id="max-${id}" value="${config.max || 100}" class="form-input" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Unit</label>
                            <span class="unit-display">${config.unit || 'W'}</span>
                        </div>
                    </div>
                    <div class="range-actions">
                        <button class="settings-btn secondary" onclick="resetRange('${id}')">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button class="settings-btn primary" onclick="saveRange('${id}')">
                            <i class="fas fa-save"></i> Save
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const icon = document.getElementById('apiKeyIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        function toggleTibberApiKeyVisibility() {
            const input = document.getElementById('tibberApiKey');
            const icon = document.getElementById('tibberApiKeyIcon');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }

        async function testTibberConnection() {
            showToast('Testing Tibber connection...', 'info');
            
            try {
                const response = await fetch(`${ingressPath}/api/tibber/test`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Connection successful! Welcome, ${data.user.name}`, 'success');
                } else {
                    showToast(`Connection failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('Error testing connection', 'error');
            }
        }

        async function refreshTibberData() {
            showToast('Refreshing Tibber data...', 'info');
            
            try {
                const response = await fetch(`${ingressPath}/api/tibber/refresh`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    showToast('Data refreshed successfully', 'success');
                    loadTibberStatus();
                } else {
                    showToast(`Refresh failed: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('Error refreshing data', 'error');
            }
        }

        async function saveRange(id) {
            const min = parseFloat(document.getElementById(`min-${id}`).value);
            const max = parseFloat(document.getElementById(`max-${id}`).value);
            
            if (isNaN(min) || isNaN(max) || min >= max) {
                showToast('Invalid range values', 'error');
                return;
            }

            try {
                const response = await fetch(`${ingressPath}/api/update-panel-range`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ panelId: id, min, max })
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Range settings saved', 'success');
                } else {
                    showToast('Failed to save range settings', 'error');
                }
            } catch (error) {
                showToast('Error saving range settings', 'error');
            }
        }

        function resetRange(id) {
            showConfirmation('Reset range settings to default values?', () => {
                // Reset to default values - you can customize these
                document.getElementById(`min-${id}`).value = '0';
                document.getElementById(`max-${id}`).value = '100';
                showToast('Range settings reset', 'info');
            });
        }

        async function autoSave() {
            // Debounce auto-save
            clearTimeout(window.autoSaveTimeout);
            window.autoSaveTimeout = setTimeout(async () => {
                try {
                    await saveCurrentSettings();
                } catch (error) {
                    console.error('Auto-save failed:', error);
                }
            }, 1000);
        }

        async function saveCurrentSettings() {
            const settings = {
                timezone: document.getElementById('timezone').value,
                apiKey: document.getElementById('apiKey').value,
                selectedZone: document.getElementById('zone').value,
                tibber: {
                    enabled: document.getElementById('tibberEnabled').checked,
                    apiKey: document.getElementById('tibberApiKey').value,
                    country: document.getElementById('tibberCountry').value
                }
            };

            // Save general settings
            if (settings.apiKey || settings.selectedZone) {
                await fetch(`${ingressPath}/settings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiKey: settings.apiKey,
                        selectedZone: settings.selectedZone
                    })
                });
            }

            // Save timezone
            if (settings.timezone) {
                await fetch(`${ingressPath}/api/timezone`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ timezone: settings.timezone })
                });
            }

            // Save Tibber settings
            await fetch(`${ingressPath}/api/tibber/config`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings.tibber)
            });

            updateStatusIndicators();
        }

        async function saveTibberSettings() {
            const tibberSettings = {
                enabled: document.getElementById('tibberEnabled').checked,
                apiKey: document.getElementById('tibberApiKey').value,
                country: document.getElementById('tibberCountry').value
            };

            try {
                const response = await fetch(`${ingressPath}/api/tibber/config`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(tibberSettings)
                });

                const data = await response.json();
                if (data.success) {
                    showToast('Tibber settings saved successfully', 'success');
                    loadTibberStatus();
                } else {
                    showToast(`Failed to save Tibber settings: ${data.error}`, 'error');
                }
            } catch (error) {
                showToast('Error saving Tibber settings', 'error');
                console.error('Error:', error);
            }
        }

        async function saveAllSettings() {
            try {
                await saveCurrentSettings();
                showToast('All settings saved successfully', 'success');
            } catch (error) {
                showToast('Error saving settings', 'error');
            }
        }

        function resetAllSettings() {
            showConfirmation('Reset all settings to default values? This action cannot be undone.', async () => {
                try {
                    // Reset form values
                    document.getElementById('timezone').value = 'UTC';
                    document.getElementById('apiKey').value = '';
                    document.getElementById('zone').value = '';
                    document.getElementById('tibberEnabled').checked = false;
                    document.getElementById('tibberApiKey').value = '';
                    document.getElementById('tibberCountry').value = 'DE';

                    await saveCurrentSettings();
                    showToast('All settings reset to defaults', 'info');
                } catch (error) {
                    showToast('Error resetting settings', 'error');
                }
            });
        }

        function exportSettings() {
            const settings = {
                timezone: document.getElementById('timezone').value,
                apiKey: document.getElementById('apiKey').value ? '***HIDDEN***' : '',
                selectedZone: document.getElementById('zone').value,
                tibber: {
                    enabled: document.getElementById('tibberEnabled').checked,
                    apiKey: document.getElementById('tibberApiKey').value ? '***HIDDEN***' : '',
                    country: document.getElementById('tibberCountry').value
                },
                exportDate: new Date().toISOString()
            };

            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'solarautopilot-settings.json';
            a.click();
            URL.revokeObjectURL(url);

            showToast('Settings exported successfully', 'success');
        }

        function updateStatusIndicators() {
            const apiKey = document.getElementById('apiKey').value;
            const zone = document.getElementById('zone').value;

            // API Status
            const apiStatus = document.getElementById('apiStatus');
            if (apiKey) {
                apiStatus.innerHTML = '<i class="fas fa-circle"></i> Connected';
                apiStatus.className = 'status-badge connected';
            } else {
                apiStatus.innerHTML = '<i class="fas fa-circle"></i> Not Configured';
                apiStatus.className = 'status-badge disconnected';
            }

            // Zone Status
            const zoneStatus = document.getElementById('zoneStatus');
            if (zone) {
                zoneStatus.innerHTML = '<i class="fas fa-circle"></i> Configured';
                zoneStatus.className = 'status-badge connected';
            } else {
                zoneStatus.innerHTML = '<i class="fas fa-circle"></i> Not Set';
                zoneStatus.className = 'status-badge disconnected';
            }
        }

        function showConfirmation(message, callback) {
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmation-modal').style.display = 'flex';
            pendingAction = callback;
        }

        function closeConfirmationModal() {
            document.getElementById('confirmation-modal').style.display = 'none';
            pendingAction = null;
        }

        function confirmAction() {
            if (pendingAction) {
                pendingAction();
                closeConfirmationModal();
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast-notification ${type}`;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };

            toast.innerHTML = `
                <div class="toast-header">
                    <i class="fas ${icons[type]}"></i>
                    <span class="toast-title">${message}</span>
                    <button class="toast-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.getElementById('toast-container').appendChild(toast);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.remove();
                }
            }, 5000);

            // Animate in
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
        }
    </script>
</body>
</html>
