<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARBONOZ SolarAutopilot - Enhanced Notifications</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="<%= ingress_path %>/css/main.css">
    <link rel="stylesheet" href="<%= ingress_path %>/css/notifications.css">
</head>
<body>
    <!-- Mobile toggle button -->
    <button class="mobile-toggle" id="mobileToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="container">
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>

        <%- include('partials/sidebar') %>

        <div class="main-content">
            <div class="container">
                <!-- Header Section -->
                <div class="notification-header">
                    <div class="header-content">
                        <h1><i class="fas fa-bell"></i> Smart Notifications</h1>
                        <p>AI-powered notification system with intelligent grouping and filtering</p>
                    </div>
                    <div class="header-actions">
                        <button class="notification-btn primary" onclick="notificationManager.loadNotifications()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                        <button class="notification-btn secondary" onclick="showSettingsModal()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                        <button class="notification-btn secondary" onclick="notificationManager.clearAll()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>

                <!-- Statistics Cards -->
                <div class="notification-stats">
                    <div class="stat-card critical">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="critical-count">0</div>
                            <div class="stat-label">Critical</div>
                        </div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="warning-count">0</div>
                            <div class="stat-label">Warnings</div>
                        </div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-info-circle"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="info-count">0</div>
                            <div class="stat-label">Info</div>
                        </div>
                    </div>
                    <div class="stat-card total">
                        <div class="stat-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-count">0</div>
                            <div class="stat-label">Total (24h)</div>
                        </div>
                    </div>
                </div>

                <!-- Notification Filters -->
                <div class="notification-filters">
                    <button class="filter-chip active" onclick="filterNotifications('all')" id="filter-all">
                        <i class="fas fa-list"></i> All Severities
                    </button>
                    <button class="filter-chip" onclick="filterNotifications('critical')" id="filter-critical">
                        <i class="fas fa-exclamation-circle"></i> üî¥ Critical
                    </button>
                    <button class="filter-chip" onclick="filterNotifications('warning')" id="filter-warning">
                        <i class="fas fa-exclamation-triangle"></i> üü° Warning
                    </button>
                    <button class="filter-chip" onclick="filterNotifications('info')" id="filter-info">
                        <i class="fas fa-info-circle"></i> üîµ Info
                    </button>
                    <button class="filter-chip" onclick="filterNotifications('ai_decision')" id="filter-ai">
                        <i class="fas fa-robot"></i> ü§ñ AI Decisions
                    </button>
                    <button class="filter-chip" onclick="filterNotifications('price_alert')" id="filter-price">
                        <i class="fas fa-dollar-sign"></i> üí∞ Price Alerts
                    </button>
                </div>

                <!-- Quick Actions -->
                <div class="quick-actions">
                    <button class="action-btn" onclick="createTestNotification('info')">
                        <i class="fas fa-plus"></i> Test Info
                    </button>
                    <button class="action-btn" onclick="createTestNotification('warning')">
                        <i class="fas fa-exclamation-triangle"></i> Test Warning
                    </button>
                    <button class="action-btn" onclick="createTestNotification('critical')">
                        <i class="fas fa-exclamation-circle"></i> Test Critical
                    </button>
                    <button class="action-btn" onclick="showConditionsModal()">
                        <i class="fas fa-cogs"></i> Conditions
                    </button>
                    <button class="action-btn" onclick="toggleSound()">
                        <i class="fas fa-volume-up" id="sound-icon"></i> <span id="sound-text">Sound On</span>
                    </button>
                </div>

                <!-- Notifications Container -->
                <div id="notifications-container" class="notifications-container">
                    <!-- Notifications will be dynamically loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="notification-modal">
        <div class="modal-overlay" onclick="closeSettingsModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Notification Settings</h3>
                <button class="modal-close" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="notification-settings">
                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fab fa-telegram"></i> Telegram Setup
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Bot Token</div>
                                <div class="option-description">Your Telegram bot token from @BotFather</div>
                            </div>
                            <input type="password" id="telegram-token" placeholder="Enter bot token" class="form-control">
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Chat ID</div>
                                <div class="option-description">Your Telegram chat ID (send /start to bot to get it)</div>
                            </div>
                            <input type="text" id="telegram-chat-id" placeholder="Enter chat ID" class="form-control">
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Connection Status</div>
                                <div class="option-description">Test and save your Telegram configuration</div>
                            </div>
                            <div class="telegram-actions">
                                <button class="notification-btn secondary" onclick="testTelegram()">Test</button>
                                <button class="notification-btn primary" onclick="saveTelegramConfig()">Save</button>
                                <span id="telegram-status" class="status-indicator"></span>
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Enable Telegram Notifications</div>
                                <div class="option-description">Send notifications to your Telegram chat</div>
                            </div>
                            <div class="option-toggle" id="telegram-toggle" onclick="toggleTelegramSetting('enabled')">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-filter"></i> Telegram Notification Types
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">AI Charging Decisions</div>
                                <div class="option-description">Notifications about AI charging start/stop decisions</div>
                            </div>
                            <div class="option-toggle active" id="telegram-ai-toggle" onclick="toggleTelegramType('aiCharging')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Battery Warnings</div>
                                <div class="option-description">Low battery and critical battery alerts</div>
                            </div>
                            <div class="option-toggle active" id="telegram-battery-toggle" onclick="toggleTelegramType('battery')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Price Alerts</div>
                                <div class="option-description">Optimal pricing and high price warnings</div>
                            </div>
                            <div class="option-toggle active" id="telegram-price-toggle" onclick="toggleTelegramType('price')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">System Status</div>
                                <div class="option-description">System errors, connection issues, and status updates</div>
                            </div>
                            <div class="option-toggle active" id="telegram-system-toggle" onclick="toggleTelegramType('system')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Critical Alerts Only</div>
                                <div class="option-description">Only send critical notifications (overrides other settings)</div>
                            </div>
                            <div class="option-toggle" id="telegram-critical-only-toggle" onclick="toggleTelegramType('criticalOnly')">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-bell"></i> General Settings
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Enable Sound Notifications</div>
                                <div class="option-description">Play sound for new critical notifications</div>
                            </div>
                            <div class="option-toggle" id="sound-toggle" onclick="toggleSetting('enableSound')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Desktop Notifications</div>
                                <div class="option-description">Show browser notifications for important alerts</div>
                            </div>
                            <div class="option-toggle" id="desktop-toggle" onclick="toggleSetting('enableDesktop')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Group Similar Notifications</div>
                                <div class="option-description">Automatically group related notifications together</div>
                            </div>
                            <div class="option-toggle active" id="group-toggle" onclick="toggleSetting('groupSimilar')">
                            </div>
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Auto-acknowledge Info Notifications</div>
                                <div class="option-description">Automatically mark info notifications as read</div>
                            </div>
                            <div class="option-toggle" id="auto-ack-toggle" onclick="toggleSetting('autoAcknowledge')">
                            </div>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-filter"></i> Display Settings
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Maximum Visible Notifications</div>
                                <div class="option-description">Number of notifications to show at once</div>
                            </div>
                            <select id="max-visible-select" onchange="updateMaxVisible(this.value)">
                                <option value="25">25</option>
                                <option value="50" selected>50</option>
                                <option value="100">100</option>
                                <option value="200">200</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-clock"></i> Quiet Hours
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Start Time</div>
                                <div class="option-description">When to start quiet hours (no non-critical notifications)</div>
                            </div>
                            <input type="time" id="quiet-start" value="22:00" onchange="updateQuietHours()">
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">End Time</div>
                                <div class="option-description">When to end quiet hours</div>
                            </div>
                            <input type="time" id="quiet-end" value="07:00" onchange="updateQuietHours()">
                        </div>
                    </div>

                    <div class="settings-section">
                        <div class="settings-title">
                            <i class="fas fa-sliders-h"></i> Threshold Settings
                        </div>
                        
                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Critical Battery Level (%)</div>
                                <div class="option-description">Battery SOC level for critical alerts</div>
                            </div>
                            <input type="number" id="critical-battery" value="10" min="5" max="30" onchange="updateThresholds()">
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Low Battery Level (%)</div>
                                <div class="option-description">Battery SOC level for warning alerts</div>
                            </div>
                            <input type="number" id="low-battery" value="20" min="10" max="50" onchange="updateThresholds()">
                        </div>

                        <div class="settings-option">
                            <div class="option-info">
                                <div class="option-title">Optimal Price Threshold (¬¢/kWh)</div>
                                <div class="option-description">Price level for optimal charging alerts</div>
                            </div>
                            <input type="number" id="optimal-price" value="8" min="0" max="20" step="0.1" onchange="updateThresholds()">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="notification-btn secondary" onclick="resetSettings()">Reset to Defaults</button>
                <button class="notification-btn primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- Test Notification Modal -->
    <div id="test-modal" class="notification-modal">
        <div class="modal-overlay" onclick="closeTestModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-flask"></i> Create Test Notification</h3>
                <button class="modal-close" onclick="closeTestModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="test-severity">Severity</label>
                    <select id="test-severity">
                        <option value="info">Info</option>
                        <option value="warning">Warning</option>
                        <option value="critical">Critical</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="test-title">Title</label>
                    <input type="text" id="test-title" placeholder="Enter notification title">
                </div>
                <div class="form-group">
                    <label for="test-message">Message</label>
                    <textarea id="test-message" rows="3" placeholder="Enter notification message"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="notification-btn secondary" onclick="closeTestModal()">Cancel</button>
                <button class="notification-btn primary" onclick="sendTestNotification()">Send Test</button>
            </div>
        </div>
    </div>

    <!-- Notification Conditions Modal -->
    <div id="conditions-modal" class="notification-modal">
        <div class="modal-overlay" onclick="closeConditionsModal()"></div>
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-cogs"></i> Notification Conditions</h3>
                <button class="modal-close" onclick="closeConditionsModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="conditions-section">
                    <div class="section-header">
                        <h4>Create Custom Notification Rules</h4>
                        <p>Set conditions for when notifications should or should NOT be sent</p>
                    </div>
                    
                    <div class="condition-rules" id="condition-rules">
                        <!-- Rules will be loaded here -->
                    </div>
                    
                    <div class="add-rule-section">
                        <h5>Add New Rule</h5>
                        <div class="rule-builder">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Rule Name</label>
                                    <input type="text" id="new-rule-name" placeholder="e.g., No notifications when PV is low">
                                </div>
                                <div class="form-group">
                                    <label>Action</label>
                                    <select id="new-rule-action">
                                        <option value="suppress">Don't Send Notification</option>
                                        <option value="allow">Send Notification</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Notification Type</label>
                                    <select id="new-rule-type">
                                        <option value="all">All Notifications</option>
                                        <option value="ai_decision">AI Decisions</option>
                                        <option value="battery_warning">Battery Warnings</option>
                                        <option value="price_alert">Price Alerts</option>
                                        <option value="system_alert">System Alerts</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Severity</label>
                                    <select id="new-rule-severity">
                                        <option value="all">All Severities</option>
                                        <option value="info">Info Only</option>
                                        <option value="warning">Warning Only</option>
                                        <option value="critical">Critical Only</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="conditions-builder">
                                <h6>When these conditions are met:</h6>
                                <div id="condition-builder">
                                    <div class="condition-row">
                                        <select class="condition-param">
                                            <option value="battery_soc">Battery SOC (%)</option>
                                            <option value="pv_power">PV Power (W)</option>
                                            <option value="load">Load (W)</option>
                                            <option value="grid_power">Grid Power (W)</option>
                                            <option value="grid_voltage">Grid Voltage (V)</option>
                                            <option value="current_price">Current Price (¬¢/kWh)</option>
                                        </select>
                                        <select class="condition-operator">
                                            <option value="lt">is less than</option>
                                            <option value="lte">is less than or equal to</option>
                                            <option value="gt">is greater than</option>
                                            <option value="gte">is greater than or equal to</option>
                                            <option value="eq">equals</option>
                                            <option value="ne">does not equal</option>
                                        </select>
                                        <input type="number" class="condition-value" placeholder="Value">
                                        <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                                <button type="button" class="notification-btn secondary" onclick="addCondition()">
                                    <i class="fas fa-plus"></i> Add Condition
                                </button>
                            </div>
                            
                            <div class="rule-actions">
                                <button type="button" class="notification-btn primary" onclick="saveRule()">
                                    <i class="fas fa-save"></i> Save Rule
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="notification-btn secondary" onclick="closeConditionsModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="<%= ingress_path %>/js/notifications.js"></script>
    <script src="<%= ingress_path %>/js/dark-mode.js"></script>
    <script src="<%= ingress_path %>/js/mobile.js"></script>

    <script>
        // Additional functionality for the enhanced notifications page
        
        function showSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
            loadCurrentSettings();
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function showTestModal() {
            document.getElementById('test-modal').style.display = 'flex';
        }

        function closeTestModal() {
            document.getElementById('test-modal').style.display = 'none';
        }

        function createTestNotification(severity) {
            const titles = {
                info: 'System Information',
                warning: 'System Warning',
                critical: 'Critical Alert'
            };
            
            const messages = {
                info: 'This is a test information notification to verify the system is working correctly.',
                warning: 'This is a test warning notification to check alert functionality.',
                critical: 'This is a test critical notification to verify emergency alerts are working.'
            };

            document.getElementById('test-severity').value = severity;
            document.getElementById('test-title').value = titles[severity];
            document.getElementById('test-message').value = messages[severity];
            showTestModal();
        }

        async function sendTestNotification() {
            const severity = document.getElementById('test-severity').value;
            const title = document.getElementById('test-title').value;
            const message = document.getElementById('test-message').value;

            if (!title || !message) {
                alert('Please fill in both title and message');
                return;
            }

            try {
                const response = await fetch('<%= ingress_path %>/api/notifications/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        severity,
                        title,
                        message,
                        type: 'test_notification'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    closeTestModal();
                    // Refresh notifications to show the new test notification
                    setTimeout(() => {
                        notificationManager.loadNotifications();
                    }, 500);
                } else {
                    alert('Failed to create test notification: ' + result.error);
                }
            } catch (error) {
                console.error('Error creating test notification:', error);
                alert('Error creating test notification');
            }
        }

        function toggleSound() {
            if (window.notificationManager) {
                notificationManager.toggleSound();
                updateSoundButton();
            }
        }

        function updateSoundButton() {
            const icon = document.getElementById('sound-icon');
            const text = document.getElementById('sound-text');
            
            if (notificationManager.soundEnabled) {
                icon.className = 'fas fa-volume-up';
                text.textContent = 'Sound On';
            } else {
                icon.className = 'fas fa-volume-mute';
                text.textContent = 'Sound Off';
            }
        }

        function toggleSetting(setting) {
            const toggle = document.getElementById(setting.replace(/([A-Z])/g, '-$1').toLowerCase() + '-toggle');
            toggle.classList.toggle('active');
            
            if (window.notificationManager) {
                notificationManager.settings[setting] = toggle.classList.contains('active');
                notificationManager.saveSettings();
            }
        }

        function updateMaxVisible(value) {
            if (window.notificationManager) {
                notificationManager.settings.maxVisible = parseInt(value);
                notificationManager.saveSettings();
                notificationManager.renderNotifications();
            }
        }

        function updateQuietHours() {
            const start = document.getElementById('quiet-start').value;
            const end = document.getElementById('quiet-end').value;
            
            if (start && end) {
                const startHour = parseInt(start.split(':')[0]);
                const endHour = parseInt(end.split(':')[0]);
                
                // Update server settings
                fetch('<%= ingress_path %>/api/notifications/settings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quietHours: { start: startHour, end: endHour }
                    })
                }).catch(console.error);
            }
        }

        function updateThresholds() {
            const criticalBattery = parseInt(document.getElementById('critical-battery').value);
            const lowBattery = parseInt(document.getElementById('low-battery').value);
            const optimalPrice = parseFloat(document.getElementById('optimal-price').value);
            
            // Update server settings
            fetch('<%= ingress_path %>/api/notifications/settings', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    thresholds: {
                        batterySOC: { critical: criticalBattery, low: lowBattery },
                        price: { optimal: optimalPrice }
                    }
                })
            }).catch(console.error);
        }

        async function testTelegram() {
            const token = document.getElementById('telegram-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            const statusEl = document.getElementById('telegram-status');
            
            if (!token || !chatId) {
                statusEl.textContent = '‚ùå Please enter both token and chat ID';
                statusEl.className = 'status-indicator error';
                return;
            }
            
            statusEl.textContent = '‚è≥ Testing...';
            statusEl.className = 'status-indicator testing';
            
            try {
                const response = await fetch('<%= ingress_path %>/api/notifications/telegram/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, chatId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusEl.textContent = '‚úÖ Connection successful';
                    statusEl.className = 'status-indicator success';
                } else {
                    statusEl.textContent = '‚ùå ' + (result.error || 'Connection failed');
                    statusEl.className = 'status-indicator error';
                }
            } catch (error) {
                statusEl.textContent = '‚ùå Test failed';
                statusEl.className = 'status-indicator error';
            }
        }
        
        async function saveTelegramConfig() {
            const token = document.getElementById('telegram-token').value;
            const chatId = document.getElementById('telegram-chat-id').value;
            
            if (!token || !chatId) {
                alert('Please enter both bot token and chat ID');
                return;
            }
            
            try {
                const response = await fetch('<%= ingress_path %>/api/notifications/telegram/config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ token, chatId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('telegram-status').textContent = '‚úÖ Configuration saved';
                    document.getElementById('telegram-status').className = 'status-indicator success';
                } else {
                    alert('Failed to save configuration: ' + result.error);
                }
            } catch (error) {
                alert('Error saving configuration');
            }
        }
        
        function toggleTelegramSetting(setting) {
            const toggle = document.getElementById('telegram-toggle');
            toggle.classList.toggle('active');
            
            const enabled = toggle.classList.contains('active');
            
            fetch('<%= ingress_path %>/api/notifications/telegram/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ enabled })
            }).catch(console.error);
        }
        
        function toggleTelegramType(type) {
            const toggle = document.getElementById(`telegram-${type.toLowerCase()}-toggle`);
            toggle.classList.toggle('active');
            
            const enabled = toggle.classList.contains('active');
            
            fetch('<%= ingress_path %>/api/notifications/telegram/types', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [type]: enabled })
            }).catch(console.error);
        }

        function loadCurrentSettings() {
            if (window.notificationManager) {
                const settings = notificationManager.settings;
                
                // Update toggles
                document.getElementById('sound-toggle').classList.toggle('active', settings.enableSound);
                document.getElementById('desktop-toggle').classList.toggle('active', settings.enableDesktop);
                document.getElementById('group-toggle').classList.toggle('active', settings.groupSimilar);
                document.getElementById('auto-ack-toggle').classList.toggle('active', settings.autoAcknowledge);
                
                // Update max visible
                document.getElementById('max-visible-select').value = settings.maxVisible;
            }
            
            // Load server settings
            fetch('<%= ingress_path %>/api/notifications/settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const settings = data.settings;
                        
                        // Update quiet hours
                        document.getElementById('quiet-start').value = 
                            String(settings.quietHours.start).padStart(2, '0') + ':00';
                        document.getElementById('quiet-end').value = 
                            String(settings.quietHours.end).padStart(2, '0') + ':00';
                        
                        // Update thresholds
                        document.getElementById('critical-battery').value = settings.thresholds.batterySOC.critical;
                        document.getElementById('low-battery').value = settings.thresholds.batterySOC.low;
                        document.getElementById('optimal-price').value = settings.thresholds.price.optimal;
                    }
                })
                .catch(console.error);
                
            // Load Telegram settings
            fetch('<%= ingress_path %>/api/notifications/telegram/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.config) {
                        document.getElementById('telegram-token').value = data.config.token || '';
                        document.getElementById('telegram-chat-id').value = data.config.chatId || '';
                        document.getElementById('telegram-toggle').classList.toggle('active', data.config.enabled);
                        
                        // Load notification types
                        const types = data.config.types || {};
                        document.getElementById('telegram-ai-toggle').classList.toggle('active', types.aiCharging !== false);
                        document.getElementById('telegram-battery-toggle').classList.toggle('active', types.battery !== false);
                        document.getElementById('telegram-price-toggle').classList.toggle('active', types.price !== false);
                        document.getElementById('telegram-system-toggle').classList.toggle('active', types.system !== false);
                        document.getElementById('telegram-critical-only-toggle').classList.toggle('active', types.criticalOnly === true);
                        
                        if (data.config.token && data.config.chatId) {
                            document.getElementById('telegram-status').textContent = '‚úÖ Configured';
                            document.getElementById('telegram-status').className = 'status-indicator success';
                        }
                    }
                })
                .catch(console.error);
        }

        function resetSettings() {
            if (confirm('Are you sure you want to reset all settings to defaults? This will also clear Telegram configuration.')) {
                // Reset client settings
                if (window.notificationManager) {
                    notificationManager.settings = {
                        enableSound: true,
                        enableDesktop: true,
                        maxVisible: 50,
                        autoAcknowledge: false,
                        groupSimilar: true
                    };
                    notificationManager.saveSettings();
                }
                
                // Reset server settings
                fetch('<%= ingress_path %>/api/notifications/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        thresholds: {
                            batterySOC: { critical: 10, low: 20 },
                            price: { optimal: 8 }
                        },
                        quietHours: { start: 22, end: 7 }
                    })
                }).catch(console.error);
                
                // Reset Telegram settings
                fetch('<%= ingress_path %>/api/notifications/telegram/reset', {
                    method: 'POST'
                }).then(() => {
                    loadCurrentSettings();
                }).catch(console.error);
            }
        }

        function saveSettings() {
            closeSettingsModal();
            // Settings are saved automatically as they're changed
        }

        // Load statistics periodically
        function loadStats() {
            fetch('<%= ingress_path %>/api/notifications/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        document.getElementById('critical-count').textContent = stats.bySeverity.critical;
                        document.getElementById('warning-count').textContent = stats.bySeverity.warning;
                        document.getElementById('info-count').textContent = stats.bySeverity.info;
                        document.getElementById('total-count').textContent = stats.last24Hours;
                    }
                })
                .catch(console.error);
        }

        // Filter notifications
        function filterNotifications(filter) {
            // Update active filter button
            document.querySelectorAll('.filter-chip').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`filter-${filter}`).classList.add('active');
            
            // Apply filter to notification manager
            if (window.notificationManager) {
                notificationManager.currentFilter = filter;
                notificationManager.renderNotifications();
            }
        }
        
        // Conditions modal functions
        function showConditionsModal() {
            document.getElementById('conditions-modal').style.display = 'flex';
            loadConditionRules();
        }
        
        function closeConditionsModal() {
            document.getElementById('conditions-modal').style.display = 'none';
        }
        
        function addCondition() {
            const builder = document.getElementById('condition-builder');
            const conditionRow = document.createElement('div');
            conditionRow.className = 'condition-row';
            conditionRow.innerHTML = `
                <select class="condition-param">
                    <option value="battery_soc">Battery SOC (%)</option>
                    <option value="pv_power">PV Power (W)</option>
                    <option value="load">Load (W)</option>
                    <option value="grid_power">Grid Power (W)</option>
                    <option value="grid_voltage">Grid Voltage (V)</option>
                    <option value="current_price">Current Price (¬¢/kWh)</option>
                </select>
                <select class="condition-operator">
                    <option value="lt">is less than</option>
                    <option value="lte">is less than or equal to</option>
                    <option value="gt">is greater than</option>
                    <option value="gte">is greater than or equal to</option>
                    <option value="eq">equals</option>
                    <option value="ne">does not equal</option>
                </select>
                <input type="number" class="condition-value" placeholder="Value">
                <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            builder.appendChild(conditionRow);
        }
        
        function removeCondition(button) {
            button.parentElement.remove();
        }
        
        async function saveRule() {
            const name = document.getElementById('new-rule-name').value;
            const action = document.getElementById('new-rule-action').value;
            const type = document.getElementById('new-rule-type').value;
            const severity = document.getElementById('new-rule-severity').value;
            
            if (!name) {
                alert('Please enter a rule name');
                return;
            }
            
            const conditions = [];
            document.querySelectorAll('.condition-row').forEach(row => {
                const param = row.querySelector('.condition-param').value;
                const operator = row.querySelector('.condition-operator').value;
                const value = parseFloat(row.querySelector('.condition-value').value);
                
                if (!isNaN(value)) {
                    conditions.push({ param, operator, value });
                }
            });
            
            if (conditions.length === 0) {
                alert('Please add at least one condition');
                return;
            }
            
            const rule = {
                name,
                action,
                type,
                severity,
                conditions,
                enabled: true
            };
            
            try {
                const response = await fetch('<%= ingress_path %>/api/notifications/rules', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(rule)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear form
                    document.getElementById('new-rule-name').value = '';
                    document.getElementById('condition-builder').innerHTML = `
                        <div class="condition-row">
                            <select class="condition-param">
                                <option value="battery_soc">Battery SOC (%)</option>
                                <option value="pv_power">PV Power (W)</option>
                                <option value="load">Load (W)</option>
                                <option value="grid_power">Grid Power (W)</option>
                                <option value="grid_voltage">Grid Voltage (V)</option>
                                <option value="current_price">Current Price (¬¢/kWh)</option>
                            </select>
                            <select class="condition-operator">
                                <option value="lt">is less than</option>
                                <option value="lte">is less than or equal to</option>
                                <option value="gt">is greater than</option>
                                <option value="gte">is greater than or equal to</option>
                                <option value="eq">equals</option>
                                <option value="ne">does not equal</option>
                            </select>
                            <input type="number" class="condition-value" placeholder="Value">
                            <button type="button" class="btn-remove-condition" onclick="removeCondition(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                    
                    loadConditionRules();
                } else {
                    alert('Failed to save rule: ' + result.error);
                }
            } catch (error) {
                alert('Error saving rule');
            }
        }
        
        async function loadConditionRules() {
            try {
                const response = await fetch('<%= ingress_path %>/api/notifications/rules');
                const result = await response.json();
                
                if (result.success) {
                    const rulesContainer = document.getElementById('condition-rules');
                    
                    if (result.rules.length === 0) {
                        rulesContainer.innerHTML = '<p class="no-rules">No custom rules configured. Create your first rule below.</p>';
                        return;
                    }
                    
                    rulesContainer.innerHTML = result.rules.map(rule => `
                        <div class="rule-item" data-rule-id="${rule.id}">
                            <div class="rule-header">
                                <div class="rule-info">
                                    <h6>${rule.name}</h6>
                                    <span class="rule-action ${rule.action}">${rule.action === 'suppress' ? 'Suppress' : 'Allow'}</span>
                                    <span class="rule-type">${rule.type} - ${rule.severity}</span>
                                </div>
                                <div class="rule-controls">
                                    <button class="toggle-rule ${rule.enabled ? 'active' : ''}" onclick="toggleRule('${rule.id}')">
                                        ${rule.enabled ? 'ON' : 'OFF'}
                                    </button>
                                    <button class="delete-rule" onclick="deleteRule('${rule.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="rule-conditions">
                                ${rule.conditions.map(c => `
                                    <span class="condition-tag">
                                        ${c.param.replace('_', ' ')} ${c.operator} ${c.value}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading rules:', error);
            }
        }
        
        async function toggleRule(ruleId) {
            try {
                const response = await fetch(`<%= ingress_path %>/api/notifications/rules/${ruleId}/toggle`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    loadConditionRules();
                }
            } catch (error) {
                console.error('Error toggling rule:', error);
            }
        }
        
        async function deleteRule(ruleId) {
            if (confirm('Are you sure you want to delete this rule?')) {
                try {
                    const response = await fetch(`<%= ingress_path %>/api/notifications/rules/${ruleId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        loadConditionRules();
                    }
                } catch (error) {
                    console.error('Error deleting rule:', error);
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadStats();
            setInterval(loadStats, 30000); // Update stats every 30 seconds
            
            // Update sound button state
            setTimeout(() => {
                updateSoundButton();
            }, 1000);
        });
    </script>
    <script src="<%= ingress_path %>/js/loading.js"></script>
    <script src="<%= ingress_path %>/js/dark-mode.js"></script>
    <script src="<%= ingress_path %>/js/mobile.js"></script>
</body>
</html>